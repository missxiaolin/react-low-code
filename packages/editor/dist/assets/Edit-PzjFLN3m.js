import{u as z,g as F,j as i,m as U,a as $,c as P,b as Q}from"./index-Co7b-eGp.js";import{g as H}from"./index-BqC4hqLw.js";import W from"./Page-ChZ2yeuG.js";import J from"./Schema-exDjRayd.js";import{u as X}from"./useDrop-DlwKLMqZ.js";import"./Render-BFQiaP3j.js";import"./util-D_3K64tU.js";import"./index-BmnTL83M.js";import"./useComponentRefs-BjsmN1lJ.js";/* empty css              */import"./isPlainObject-CKAOE8ju.js";import"./action-BMieVQE-.js";import"./page.module-BuTD7ApJ.js";import"./useDragDropManager-WNxthqwr.js";const Y=window.antd.Space,R=window.antd.Tooltip,Z=window.React.memo,q=window.React.useEffect,_=window.React.useState,ee=window.icons.CopyOutlined,te=window.icons.DeleteOutlined,oe=window.icons.ArrowUpOutlined,ne=window.icons.ArrowDownOutlined,ie=Z(({hoverTarget:r,copyElement:d,pastElement:f,delElement:u})=>{var I,N,O,o,c,s;let a={};const{selectedElement:t,page:p,isUpdateToolbar:T,setSelectedElement:D,moveElements:x}=z(e=>e),{elements:M}=p;(()=>{const e=t==null?void 0:t.id,n=e?p.elementsMap[e]:null;if(n){if(n.parentId){const{id:v,type:k,name:m}=p.elementsMap[n.parentId];a.parent={id:v,type:k,name:m}}a.current={id:n.id,type:n.type,name:n.name};const l=Object.values(p.elementsMap).find(v=>v.parentId===n.id);l&&(a.child={id:l.id,type:l.type,name:l.name})}})();const[j,C]=_({}),[S,b]=_({}),[A,g]=_("rightTop");q(()=>{if(!t){C({display:"none"}),g("");return}setTimeout(()=>{const e=document.querySelector(`[data-id=${t==null?void 0:t.id}]`);if(!e)return;const n=F(e);e.offsetLeft<144-n.width?g("bottomLeft"):e.offsetTop<24?g("bottomRight"):g("rightTop"),C(n)},10)},[t,M,T]),q(()=>{if(r){const e=F(r);b({...e})}else b({...S,visibility:"hidden"})},[r]);const y=(e,{id:n,type:l})=>{!n||!l||(D({id:n,type:l}),e.stopPropagation())},w=(e,n)=>{x({componentId:t==null?void 0:t.id,direction:n}),e.stopPropagation()};return i.jsxs(i.Fragment,{children:[i.jsx("div",{className:t?"toolbar-box selected":"toolbar-box",style:j,id:"editorToolbar",children:i.jsxs("div",{className:"tool-bar "+A,children:[i.jsxs("div",{className:"node-nav",children:[a.parent&&i.jsx("span",{className:"node-tip parent",onClick:e=>y(e,a.parent),children:((I=a.parent)==null?void 0:I.name)||((N=a.parent)==null?void 0:N.type)}),i.jsx("span",{className:"node-tip current",onClick:e=>y(e,a.current),children:((O=a.current)==null?void 0:O.name)||((o=a.current)==null?void 0:o.type)}),a.child&&i.jsx("span",{className:"node-tip child",onClick:e=>y(e,a.child),children:((c=a.child)==null?void 0:c.name)||((s=a.child)==null?void 0:s.type)})]}),i.jsxs(Y,{className:"actions",children:[i.jsx(R,{title:"上移动",children:i.jsx(oe,{onClick:e=>w(e,"up")})}),i.jsx(R,{title:"下移动",children:i.jsx(ne,{onClick:e=>w(e,"down")})}),i.jsx(R,{title:"复制",children:i.jsx(ee,{onClick:e=>{d(),f(),e.stopPropagation()}})}),i.jsx(R,{title:"删除",children:i.jsx(te,{onClick:e=>{u(),e.stopPropagation()}})})]})]})}),i.jsx("div",{className:r?"toolbar-box hover":"toolbar-box",style:S})]})}),B={set(r,d){localStorage.setItem(r,JSON.stringify(d))},get(r){const d=localStorage.getItem(r);if(!d)return"";try{return JSON.parse(d)}catch(f){return f}},remove(r){localStorage.removeItem(r)},clear(){localStorage.clear()}},se=window.antd.ConfigProvider,ae=window.antd.theme,re=window.React,ce=window.React.useEffect,V=window.React.useState,de=window.ahooks.useDebounceFn;function be(){const[r,d]=V(null),{theme:f,mode:u,addElement:a,selectedElement:t,setSelectedElement:p,page:T,savePageInfo:D,addChildElements:x,removeElements:M}=z(o=>o),{elementsMap:h,elements:j}=T,[C,S]=V(!1);ce(()=>(D({config:J.config,events:J.events}),S(!0),()=>{d(null),p(void 0)}),[]);const[,b]=X({accept:"MENU_ITEM",async drop(o,c){var k;if(c.didDrop())return;const{config:s,events:e,methods:n=[],elements:l=[]}=((k=await H(o.type+"Config"))==null?void 0:k.default)||{};if(!Q(o.type,t==null?void 0:t.id,t==null?void 0:t.type,h)){U.info("请把表单项放在Form容器内");return}const v=l.map(async m=>{var L;const{config:E,events:G,methods:K=[]}=((L=await H(m.type+"Config"))==null?void 0:L.default)||{};return{id:P(m.type),name:m.name,type:m.type,parentId:o.id,config:E,events:G,methods:K}})||[];Promise.all(v).then(m=>{a({type:o.type,name:o.name,id:o.id,config:s,events:e,methods:n,elements:m})})},collect:o=>({isOver:o.isOver(),canDrop:o.canDrop()})}),A=o=>{if(o.stopPropagation(),u==="preview")return;const s=o.target.closest("[data-id]");if(s){const e=s==null?void 0:s.dataset.id;if(e===(t==null?void 0:t.id))return;p({id:e,type:s==null?void 0:s.dataset.type}),d(null)}else t!=null&&t.id&&p(void 0)},g=o=>{const c=o.target;if(u==="preview")return;const s=c.closest("[data-id]");if(s){const e=s==null?void 0:s.dataset.id;if(e===(t==null?void 0:t.id)||e===(r==null?void 0:r.dataset.id))return;d(s)}else r&&d(null);o.stopPropagation()},{run:y}=de(g,{wait:150});function w(o,c){var s;for(let e=0;e<o.length;e++){const n=P(o[e].id.split("_")[0]);x({...h[o[e].id],parentId:c,elements:[],id:n}),((s=o[e].elements)==null?void 0:s.length)>0&&w(o[e].elements,n)}}const I=()=>{B.set("copy_component",t==null?void 0:t.id)},N=()=>{var s;const o=B.get("copy_component");if(!o)return U.info("暂无复制内容");let c=(s=h[o])==null?void 0:s.parentId;if((t==null?void 0:t.id)!==o&&(c=t==null?void 0:t.id),c){const{element:e}=$(j,o),n=P(o.split("_")[0]);x({...h[o],elements:[],parentId:c,id:n}),w((e==null?void 0:e.elements)||[],n)}else{const{element:e}=$(j,o),n=P(o.split("_")[0]);a({...h[o],elements:[],id:n}),w((e==null?void 0:e.elements)||[],n)}},O=()=>{t&&M(t.id)};return i.jsx(se,{theme:{cssVar:!0,hashed:!1,algorithm:ae.defaultAlgorithm,token:{colorPrimary:f||"#1677ff",colorLink:f||"#1677ff",colorInfo:f||"#1677ff"}},children:i.jsx("div",{ref:b,className:u==="edit"?"xl-editor":"xl-preview",children:i.jsxs("div",{id:"editor",className:"page-wrapper",style:u==="preview"?{height:"calc(100vh - 64px)",overflow:"auto",padding:0}:{height:"100%"},onClick:A,onMouseOver:y,children:[u==="edit"&&i.jsx(ie,{copyElement:I,pastElement:N,delElement:O,hoverTarget:r}),i.jsx(re.Suspense,{fallback:i.jsx("div",{children:"Loading..."}),children:C&&i.jsx(W,{})})]})})})}export{be as default};
